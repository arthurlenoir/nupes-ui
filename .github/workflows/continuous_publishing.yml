name: Publish patch version on new commit

on:
  push:
    branches:
      - main

jobs:
  publish-package:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: 🔧 Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: yarn

      - name: ➕ Increment patch version
        run: |
          yarn config set version-git-tag false
          git config --local user.name "[BOT] Deployer"
          yarn version --patch --no-git-tag-version

      - name: 🔧 Install dependencies
        run: yarn install --frozen-lockfile

      - name: 🔧 Build
        run: yarn build

      - name: 🔧 Create package
        run: yarn pack

      - name: Push version incrementation
        run: |
          git config --local user.name "[BOT] Deployer"
          git add package.json
          git commit -m "[skip ci] new package version"
          export REMOTE="https://${{ github.actor }}:${{ secrets.TOKEN_GITHUB }}@github.com/${GITHUB_REPOSITORY}.git"
          git push "${REMOTE}" HEAD:main

      - name: 🙊 Setup registry for publication
        uses: actions/setup-node@v2
        with:
          registry-url: 'https://npm.pkg.github.com'

      - name: 🚀 Publish package on github packages
        run: yarn publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
